<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>GUA‚Äôƒ® APP | Pro</title>

<link rel="manifest" href="manifiesto.json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* ================= ESTILOS GENERALES ================= */
:root { --primary: #0b5ed7; --bg-app: #D32F2F; --text-dark: #24292f; }
body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-app); padding-bottom: 80px; }

/* ================= LOGIN ================= */
#login-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #ffffff; z-index: 9999;
    display: flex; flex-direction: column; align-items: center;
    padding-top: 40px; box-sizing: border-box; color: var(--text-dark); overflow-y: auto;
}
.login-logo-img { width: 80px; height: auto; margin-bottom: 20px; }
.login-box {
    background-color: #f6f8fa; border: 1px solid #d8dee4; border-radius: 6px;
    padding: 20px; width: 90%; max-width: 310px; margin-bottom: 15px;
}
.login-input {
    width: 100%; padding: 5px 12px; font-size: 14px; height: 35px;
    border: 1px solid #d0d7de; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box;
}
.btn-login-primary {
    width: 100%; background-color: #2da44e; color: #ffffff;
    border: 1px solid rgba(27,31,35,0.15); border-radius: 6px;
    padding: 5px 16px; font-size: 14px; font-weight: 600; cursor: pointer; height: 35px;
}

/* ================= APP ================= */
#app-container { display: none; } 
.app-header { background: rgba(0,0,0,0.2); color: white; padding: 20px 15px; text-align: center; }
.app-header img { width: 220px; max-width: 90%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
.container { max-width: 600px; margin: 0 auto; padding: 15px; }

.card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
h2 { font-size: 15px; color: var(--bg-app); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 8px; text-transform: uppercase; font-weight: 800; display:flex; justify-content:space-between; align-items:center; }

label { display: block; font-size: 11px; color: #555; margin-top: 10px; font-weight: 700; text-transform:uppercase; }
input.app-input, select.app-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-top: 5px; background: #f9f9f9; }
select.app-input { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 10px center; background-size: 1em; }

/* Firma Digital */
canvas#signature-pad {
    border: 2px dashed #ccc; border-radius: 8px; width: 100%; height: 150px; cursor: crosshair; background: #fff; touch-action: none;
}
.signature-tools { display: flex; justify-content: flex-end; gap: 10px; margin-top: 5px; }
.btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 5px; border:none; cursor:pointer; background:#eee; color:#333; }

/* Totales */
.total-box { background: #fff3f3; padding: 15px; border-radius: 10px; border: 1px dashed #ffcccc; }
.t-row { display: flex; justify-content: space-between; font-size: 13px; color: #666; margin-bottom: 5px; }
.t-row.final { border-top: 1px solid #ffcccc; margin-top: 8px; padding-top: 8px; color: var(--bg-app); font-weight: 900; font-size: 18px; }

/* Botones */
.btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; margin-top: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
.btn-whatsapp { background: #25D366; color: white; }
.btn-pdf { background: #1a1a1a; color: white; }
.btn-danger { background: #ff4444; color: white; font-size: 12px; padding: 5px 10px; width: auto; display: inline-flex; }

/* Footer */
.footer-app { text-align: center; font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 30px; }
.footer-whatsapp { display: flex; align-items: center; justify-content: center; margin-top: 8px; color: #25D366; font-weight: bold; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 20px; width: fit-content; margin-left: auto; margin-right: auto; padding-right: 15px; }

/* ================= PDF TEMPLATE (PROFESIONAL) ================= */
#pdf-template {
    position: fixed; top: 0; left: -9999px;
    width: 800px; background: white; padding: 40px 50px;
    font-family: 'Helvetica', 'Arial', sans-serif; color: #000; box-sizing: border-box; font-size: 14px;
}
.pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
.tech-branding h1 { margin: 0; font-size: 26px; text-transform: uppercase; font-weight: 900; color: var(--theme-color, #000); }
.pdf-client-box { border: 1px solid #ccc; padding: 20px; margin-bottom: 20px; background: #fdfdfd; }
.pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 12px; }
.pdf-table th { background: var(--theme-color, #333); color: white; padding: 12px; text-align: left; }
.pdf-table td { border: 1px solid #ccc; padding: 12px; }
.grand-total { background: var(--theme-color, #333); color: white !important; font-size: 16px !important; font-weight: 900 !important; }
.pdf-signature-area { margin-top: 40px; border-top: 1px solid #000; width: 250px; text-align: center; padding-top: 5px; font-size: 12px; }
.pdf-footer { margin-top: 40px; border-top: 1px solid #ddd; padding-top: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
</style>
</head>

<body>

<div id="login-screen">
    <img src="logotipo-guaiapp.png" class="login-logo-img" alt="Logo">
    <h2 style="color:#333; margin-top:0">Acceso Profesional</h2>
    <div class="login-box">
        <div id="step-email">
            <label class="login-label">Correo electr√≥nico</label>
            <input type="email" id="loginEmail" class="login-input" placeholder="tu@email.com">
            <button class="btn-login-primary" onclick="sendAuthCode()">Enviar C√≥digo de Acceso</button>
        </div>
        <div id="step-code" style="display:none">
            <label class="login-label" style="text-align:center">C√≥digo de verificaci√≥n</label>
            <input type="number" id="loginCode" class="login-input" style="text-align:center; font-weight:bold; letter-spacing:5px;">
            <button class="btn-login-primary" onclick="verifyCode()">Entrar</button>
            <p style="text-align:center; font-size:12px; margin-top:10px; cursor:pointer; color:blue" onclick="location.reload()">Cancelar</p>
        </div>
    </div>
    <div style="font-size:11px; color:#999">Gua'i App v3.0 - Seguridad RHAB Tech</div>
</div>

<div id="app-container">
    <div class="app-header">
        <img src="logotipo-guaiapp.png" alt="Gua'i App">
        <h3 style="color:white; margin-top:5px; font-weight:300">Generador de Presupuestos</h3>
    </div>

    <div class="container">
        <div class="card" style="border-left: 5px solid #FFC107;">
            <h2 style="border:none; padding:0; margin:0;">üé® Personalizar PDF</h2>
            <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <label style="margin:0;">Color de Tema:</label>
                <input type="color" id="pdfColor" value="#0b5ed7" style="height:35px; width:60px; border:none; padding:0; background:none;">
            </div>
        </div>

        <div class="card">
            <h2>üë§ Cliente</h2>
            <input id="cliente" class="app-input" placeholder="Nombre del Cliente">
            <input id="rucCliente" class="app-input" placeholder="RUC / CI">
            <input id="telCliente" class="app-input" placeholder="Tel√©fono">
        </div>

        <div class="card">
            <h2>üõ†Ô∏è T√©cnico / Empresa</h2>
            <input id="tecnico" class="app-input" placeholder="Nombre T√©cnico">
            <input id="empresa" class="app-input" placeholder="Empresa (Opcional)">
            <input id="telTecnico" class="app-input" placeholder="Tel√©fono de Contacto">
        </div>

        <div class="card">
            <h2>üìã Servicios & Productos</h2>
            
            <div style="margin-bottom:15px; border-bottom:1px dashed #eee; padding-bottom:10px;">
                <label>Servicio 1 (Seleccionar)</label>
                <select id="desc1" class="app-input">
                    <option value="">Seleccione...</option>
                    <option value="Mantenimiento Preventivo A.A. 9.000 BTU">Mant. Preventivo 9.000 BTU</option>
                    <option value="Mantenimiento Preventivo A.A. 12.000 BTU">Mant. Preventivo 12.000 BTU</option>
                    <option value="Mantenimiento Preventivo A.A. 18.000 BTU">Mant. Preventivo 18.000 BTU</option>
                    <option value="Mantenimiento Preventivo A.A. 24.000 BTU">Mant. Preventivo 24.000 BTU</option>
                    <option value="Carga de Gas R22">Carga de Gas R22</option>
                    <option value="Carga de Gas R410A">Carga de Gas R410A</option>
                </select>
                <input type="number" id="s1" class="app-input" placeholder="Precio (Gs.)" oninput="calc()">
            </div>

            <div style="margin-bottom:15px; border-bottom:1px dashed #eee; padding-bottom:10px;">
                <label>Servicio 2 (Seleccionar)</label>
                <select id="desc2" class="app-input">
                    <option value="">Seleccione...</option>
                    <option value="Instalaci√≥n A.A. Split">Instalaci√≥n A.A. Split</option>
                    <option value="Desinstalaci√≥n A.A.">Desinstalaci√≥n A.A.</option>
                    <option value="Cambio de Capacitor">Cambio de Capacitor</option>
                    <option value="Reparaci√≥n de Placa">Reparaci√≥n de Placa</option>
                </select>
                <input type="number" id="s2" class="app-input" placeholder="Precio (Gs.)" oninput="calc()">
            </div>

            <div>
                <label>Otro Servicio (Personalizado)</label>
                <input type="text" id="desc3" class="app-input" placeholder="Descripci√≥n manual">
                <input type="number" id="s3" class="app-input" placeholder="Precio (Gs.)" oninput="calc()">
            </div>
        </div>

        <div class="card">
            <div class="total-box">
                <div class="t-row"><span>Subtotal Exentas:</span><span>0</span></div>
                <div class="t-row"><span>Subtotal IVA (10%):</span><span id="subDisplay">0</span></div>
                <div class="t-row"><span>Liquidaci√≥n IVA:</span><span id="ivaDisplay">0</span></div>
                <div class="t-row final"><span>TOTAL:</span><span>Gs. <span id="totalDisplay">0</span></span></div>
            </div>
        </div>

        <div class="card">
            <h2>‚úçÔ∏è Firma / Conformidad</h2>
            <p style="font-size:11px; color:#666; margin-bottom:5px;">Firme en el recuadro blanco:</p>
            <canvas id="signature-pad"></canvas>
            <div class="signature-tools">
                <button class="btn-sm" onclick="clearSignature()">Borrar Firma</button>
            </div>
        </div>

        <div class="card" style="background:transparent; box-shadow:none; padding:0;">
            <button class="btn btn-pdf" onclick="generatePDF('download')">üìÑ Descargar PDF</button>
            <button class="btn btn-whatsapp" onclick="generatePDF('whatsapp')">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326z"/></svg>
                Enviar PDF por WhatsApp
            </button>
            <button id="btnInstalar" class="btn" style="background:#FFC107; color:#333; display:none">üì≤ Instalar App</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>üìÇ Historial</h2>
                <button class="btn-danger" onclick="clearHistory()">Borrar</button>
            </div>
            <div id="history-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>

        <div class="footer-app">
            <b>GUA'I APP</b><br>
            Desarrollado por RHAB Tech<br>
            Divisi√≥n de RHAB INTERNATIONAL TRADING<br>
            guaiapp@rhabinternationaltrading.com
            <div class="footer-whatsapp" onclick="window.open('https://wa.me/595992755100')">
                +595 992 755 100
            </div>
        </div>
    </div>
</div>

<div id="pdf-template">
    <div class="pdf-header">
        <div class="tech-branding">
            <h1 id="pdf-empresa-header">EMPRESA</h1>
            <div id="pdf-tecnico-sub" style="font-size:14px; color:#555">T√©cnico</div>
            <div id="pdf-tel-header" style="font-size:14px; margin-top:5px">Tel: ...</div>
        </div>
        <div class="doc-info" style="text-align:right">
            <div style="background:#333; color:white; padding:8px 20px; font-weight:bold; font-size:16px; display:inline-block; margin-bottom:10px;" id="pdf-badge">PRESUPUESTO</div>
            <div style="font-size:12px;">
                N¬∞: <strong id="pdf-nro">0001</strong><br>
                Fecha: <span id="pdf-fecha">--</span>
            </div>
        </div>
    </div>

    <div class="pdf-client-box">
        <div style="font-weight:bold; border-bottom:1px solid #ddd; margin-bottom:10px; padding-bottom:5px; font-size:11px; color:#666;">DATOS DEL CLIENTE</div>
        <table style="width:100%">
            <tr>
                <td style="padding:4px 0;"><strong>Cliente:</strong> <span id="pdf-cliente">-</span></td>
                <td style="padding:4px 0;"><strong>RUC / CI:</strong> <span id="pdf-ruc">-</span></td>
            </tr>
            <tr>
                <td style="padding:4px 0;"><strong>Tel√©fono:</strong> <span id="pdf-tel-cli">-</span></td>
                <td></td>
            </tr>
        </table>
    </div>

    <table class="pdf-table">
        <thead>
            <tr>
                <th style="width: 70%">Descripci√≥n del Servicio</th>
                <th style="text-align:right">Importe (Gs)</th>
            </tr>
        </thead>
        <tbody id="pdf-table-body"></tbody>
    </table>

    <div style="display:flex; justify-content:space-between; margin-top:30px;">
        <div style="width:40%;">
            <div style="font-size:10px; color:#666; margin-bottom:50px;">Firma / Conformidad:</div>
            <img id="pdf-signature-img" style="max-width:150px; max-height:80px; display:none;">
            <div style="border-top:1px solid #000; width:80%; margin-top:5px;"></div>
        </div>

        <div style="text-align:right;">
            <table style="width:300px; margin-left:auto; border-collapse:collapse;">
                <tr><td style="padding:8px;">Subtotal IVA 10%:</td><td style="text-align:right; font-weight:bold" id="pdf-sub">0</td></tr>
                <tr><td style="padding:8px;">Liquidaci√≥n IVA:</td><td style="text-align:right; font-weight:bold" id="pdf-iva">0</td></tr>
                <tr class="grand-total"><td style="color:white; padding:12px;">TOTAL Gs.</td><td style="color:white; padding:12px; text-align:right;" id="pdf-total">0</td></tr>
            </table>
        </div>
    </div>

    <div class="pdf-footer">
        <div style="font-size:10px; color:#666; width:60%; line-height:1.4;">
            <strong>Condiciones Comerciales:</strong><br>
            Presupuesto v√°lido por 7 d√≠as. Garant√≠a sobre mano de obra por 90 d√≠as.<br>
            El servicio no incluye repuestos salvo que se detallen expl√≠citamente.
        </div>
        <div class="pdf-app-brand" style="text-align:right;">
            <img src="logotipo-guaiapp.png" crossorigin="anonymous" style="height:40px; margin-bottom:5px;">
            <div style="font-size:9px; color:#888;">Tecnolog√≠a provista por <b>RHAB Tech</b><br>RHAB INTERNATIONAL TRADING</div>
        </div>
    </div>
</div>

<script>
// --- 1. LOGIN ---
let serverCode = null;
const isLoggedIn = localStorage.getItem("guaiapp_user");
if(isLoggedIn) {
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("app-container").style.display = "block";
    renderHistory();
}

async function sendAuthCode() {
    const email = document.getElementById("loginEmail").value;
    if(!email.includes("@")) return Swal.fire("Error", "Ingrese un correo v√°lido", "error");

    serverCode = Math.floor(100000 + Math.random() * 900000).toString();
    Swal.fire({ title: 'Conectando...', didOpen: () => Swal.showLoading() });

    try {
        // IMPORTANTE: REEMPLAZA ESTA URL CON TU DOMINIO REAL EN MAXDOMINIOS
        const response = await fetch('https://rhabinternationaltrading.com/guaiapp/enviar.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, codigo: serverCode })
        });
        const result = await response.json();

        if(result.success) {
            Swal.fire("Enviado", "Revise su correo para ver el c√≥digo.", "success");
            document.getElementById("step-email").style.display = "none";
            document.getElementById("step-code").style.display = "block";
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        Swal.fire({ icon: 'warning', title: 'Modo Offline', html: 'Sin conexi√≥n al servidor.<br>C√≥digo temporal: <b>'+serverCode+'</b>' });
        document.getElementById("step-email").style.display = "none";
        document.getElementById("step-code").style.display = "block";
    }
}

function verifyCode() {
    if(document.getElementById("loginCode").value === serverCode) {
        localStorage.setItem("guaiapp_user", document.getElementById("loginEmail").value);
        location.reload();
    } else {
        Swal.fire("Error", "C√≥digo incorrecto", "error");
    }
}

// --- 2. FIRMA DIGITAL (CANVAS) ---
const canvas = document.getElementById("signature-pad");
const ctx = canvas.getContext("2d");
let painting = false;

// Ajustar tama√±o del canvas
function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    ctx.scale(ratio, ratio);
}
window.onresize = resizeCanvas;
resizeCanvas();

function startPosition(e) { painting = true; draw(e); }
function endPosition() { painting = false; ctx.beginPath(); }
function draw(e) {
    if (!painting) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;
    
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000"; // Color firma
    
    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
}

// Eventos Mouse y Touch
canvas.addEventListener("mousedown", startPosition);
canvas.addEventListener("mouseup", endPosition);
canvas.addEventListener("mousemove", draw);
canvas.addEventListener("touchstart", startPosition);
canvas.addEventListener("touchend", endPosition);
canvas.addEventListener("touchmove", draw);

function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

// --- 3. C√ÅLCULOS ---
function calc() {
    const s1 = Number(document.getElementById("s1").value) || 0;
    const s2 = Number(document.getElementById("s2").value) || 0;
    const s3 = Number(document.getElementById("s3").value) || 0;
    const total = s1 + s2 + s3; // s3 es el "otro" ahora
    const iva = Math.round(total / 11);
    const sub = total - iva;

    document.getElementById("totalDisplay").innerText = total.toLocaleString("es-PY");
    document.getElementById("subDisplay").innerText = sub.toLocaleString("es-PY");
    document.getElementById("ivaDisplay").innerText = iva.toLocaleString("es-PY");
    return { total, iva, sub, s1, s2, s3 };
}

// --- 4. GENERAR PDF PERSONALIZADO ---
async function generatePDF(action) {
    const data = calc();
    if(data.total === 0) return Swal.fire("Atenci√≥n", "Cargue al menos un servicio", "warning");

    // 1. Aplicar Color Personalizado
    const color = document.getElementById("pdfColor").value;
    const rootStyles = document.documentElement.style;
    rootStyles.setProperty('--theme-color', color); // No funciona directo en html2pdf a veces, as√≠ que inyectamos:
    document.querySelector(".tech-branding h1").style.color = color;
    document.querySelector(".pdf-table th").style.backgroundColor = color;
    document.querySelector(".grand-total").style.backgroundColor = color;
    document.getElementById("pdf-badge").style.backgroundColor = color;

    // 2. Datos Texto
    const nro = "GUA-" + Math.floor(Math.random() * 9000 + 1000);
    const fecha = new Date().toLocaleDateString("es-PY");
    const empresa = document.getElementById("empresa").value;
    const tecnico = document.getElementById("tecnico").value || "T√âCNICO";
    
    document.getElementById("pdf-empresa-header").innerText = empresa || tecnico;
    document.getElementById("pdf-tecnico-sub").innerText = empresa ? tecnico : "Servicios T√©cnicos";
    document.getElementById("pdf-tel-header").innerText = "Tel: " + document.getElementById("telTecnico").value;
    document.getElementById("pdf-nro").innerText = nro;
    document.getElementById("pdf-fecha").innerText = fecha;
    document.getElementById("pdf-cliente").innerText = document.getElementById("cliente").value;
    document.getElementById("pdf-ruc").innerText = document.getElementById("rucCliente").value;
    document.getElementById("pdf-tel-cli").innerText = document.getElementById("telCliente").value;

    // 3. Tabla (Leyendo Selects)
    const tbody = document.getElementById("pdf-table-body");
    tbody.innerHTML = "";
    
    // Funci√≥n auxiliar para agregar fila
    const addRow = (desc, val) => {
        if(val > 0 && desc) tbody.innerHTML += `<tr><td>${desc}</td><td style="text-align:right">${val.toLocaleString("es-PY")}</td></tr>`;
    };

    // Obtenemos valores de los selects o inputs
    const d1 = document.getElementById("desc1").value;
    const v1 = Number(document.getElementById("s1").value);
    addRow(d1, v1);

    const d2 = document.getElementById("desc2").value;
    const v2 = Number(document.getElementById("s2").value);
    addRow(d2, v2);

    const d3 = document.getElementById("desc3").value || "Servicio Adicional"; // Manual
    const v3 = Number(document.getElementById("s3").value);
    addRow(d3, v3);

    // Totales
    document.getElementById("pdf-sub").innerText = data.sub.toLocaleString("es-PY");
    document.getElementById("pdf-iva").innerText = data.iva.toLocaleString("es-PY");
    document.getElementById("pdf-total").innerText = data.total.toLocaleString("es-PY");

    // 4. Insertar Firma
    const signatureImg = document.getElementById("pdf-signature-img");
    // Verificar si el canvas no est√° vac√≠o (muy b√°sico, verifica si hay pixels negros)
    // Para simplificar, siempre exportamos, si est√° vac√≠o sale transparente.
    signatureImg.src = canvas.toDataURL(); 
    signatureImg.style.display = "block";

    // 5. Generar
    const element = document.getElementById("pdf-template");
    const opt = {
        margin: [10, 10, 10, 10], 
        filename: `Presupuesto_${nro}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, windowWidth: 800 },
        jsPDF: { unit: 'mm', format: 'legal', orientation: 'portrait' }
    };

    if(action === 'download') {
        html2pdf().set(opt).from(element).save().then(() => addToHistory(nro, data.total));
    } else {
        Swal.fire({title: 'Generando...', didOpen: () => Swal.showLoading()});
        html2pdf().set(opt).from(element).outputPdf('blob').then(async (pdfBlob) => {
            Swal.close();
            const file = new File([pdfBlob], `Presupuesto_${nro}.pdf`, { type: "application/pdf" });
            if (navigator.share && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: 'Presupuesto' });
            } else {
                Swal.fire("Info", "Se descargar√° el PDF. Adj√∫ntelo en WhatsApp.", "info");
                const a = document.createElement("a"); a.href = URL.createObjectURL(pdfBlob); a.download = `Presupuesto_${nro}.pdf`; a.click();
            }
            addToHistory(nro, data.total);
        });
    }
}

// --- 5. HISTORIAL ---
function addToHistory(nro, total) {
    const cliente = document.getElementById("cliente").value || "Cliente";
    const history = JSON.parse(localStorage.getItem("guai_history") || "[]");
    history.unshift({ nro, date: new Date().toLocaleDateString(), client: cliente, amount: total.toLocaleString("es-PY") });
    localStorage.setItem("guai_history", JSON.stringify(history));
    renderHistory();
}
function renderHistory() {
    const list = document.getElementById("history-list");
    const history = JSON.parse(localStorage.getItem("guai_history") || "[]");
    list.innerHTML = "";
    if(history.length === 0) { list.innerHTML = '<p style="text-align:center; color:#999; font-size:12px;">Sin registros.</p>'; return; }
    history.forEach(i => list.innerHTML += `<div class="history-item"><div><strong>${i.client}</strong><br><span class="history-date">${i.date} ‚Ä¢ ${i.nro}</span></div><div style="font-weight:bold">Gs. ${i.amount}</div></div>`);
}
function clearHistory() { localStorage.removeItem("guai_history"); renderHistory(); }
renderHistory();

// --- 6. PWA ---
let deferredPrompt;
window.addEventListener("beforeinstallprompt", e => { e.preventDefault(); deferredPrompt = e; document.getElementById("btnInstalar").style.display = "flex"; });
document.getElementById("btnInstalar").onclick = async () => { if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; } };
if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");
</script>
</body>
</html>
