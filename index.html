<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Iniciar sesi√≥n ¬∑ GUA‚Äôƒ® APP</title>

<link rel="manifest" href="manifiesto.json">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* ================= ESTILOS GENERALES APP ================= */
:root { --primary: #0b5ed7; --bg-app: #D32F2F; --text-dark: #24292f; }
body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg-app); }

/* ================= PANTALLA DE LOGIN (ESTILO GITHUB / REF) ================= */
#login-screen {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #ffffff; /* Fondo blanco limpio */
    z-index: 9999;
    display: flex; flex-direction: column; align-items: center;
    padding-top: 40px; box-sizing: border-box; color: var(--text-dark);
    overflow-y: auto;
}

.login-logo-img { width: 60px; height: auto; margin-bottom: 24px; border-radius: 50%; } /* Logo circular estilo GitHub */

.login-title {
    font-size: 24px; font-weight: 300; letter-spacing: -0.5px; margin-bottom: 15px;
    text-align: center; color: #333;
}

.login-box {
    background-color: #f6f8fa; /* Fondo gris muy suave de la tarjeta */
    border: 1px solid #d8dee4;
    border-radius: 6px;
    padding: 20px;
    width: 90%; max-width: 310px; /* Ancho similar a la ref */
    margin-bottom: 15px;
}

.login-label {
    display: block; margin-bottom: 8px; font-weight: 400; font-size: 14px; color: var(--text-dark); text-align: left;
}

.login-input {
    width: 100%; padding: 5px 12px; font-size: 14px; line-height: 20px;
    color: var(--text-dark); background-color: #fff;
    border: 1px solid #d0d7de; border-radius: 6px;
    box-shadow: inset 0 1px 0 rgba(208,215,222,0.2);
    margin-bottom: 15px; box-sizing: border-box;
    height: 32px;
}
.login-input:focus {
    border-color: #0969da; outline: none; box-shadow: 0 0 0 3px rgba(9,105,218,0.3);
}

/* Bot√≥n Verde estilo GitHub */
.btn-login-primary {
    width: 100%; background-color: #2da44e; color: #ffffff;
    border: 1px solid rgba(27,31,35,0.15); border-radius: 6px;
    padding: 5px 16px; font-size: 14px; font-weight: 600;
    line-height: 20px; cursor: pointer; text-align: center;
    height: 34px; margin-top: 5px;
}
.btn-login-primary:hover { background-color: #2c974b; }

.login-divider {
    text-align: center; margin: 15px 0; position: relative;
    font-size: 12px; color: #57606a;
}
.login-divider::before {
    content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #d8dee4; z-index: 1;
}
.login-divider span {
    background: #f6f8fa; padding: 0 10px; position: relative; z-index: 2;
}

/* Bot√≥n Google / Secundario */
.btn-login-google {
    width: 100%; background-color: #ffffff; color: var(--text-dark);
    border: 1px solid #d0d7de; border-radius: 6px;
    padding: 5px 16px; font-size: 14px; font-weight: 500;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
    height: 34px;
}
.btn-login-google:hover { background-color: #f3f4f6; }

.login-footer-links {
    margin-top: 20px; font-size: 12px; text-align: center; color: #0969da;
}
.login-footer-links span { margin: 0 5px; cursor: pointer; }
.login-footer-links span:hover { text-decoration: underline; }

/* ================= INTERFAZ DE LA APP (OCULTA) ================= */
#app-container { display: none; padding-bottom: 60px; } 

.app-header { background: rgba(0,0,0,0.2); color: white; padding: 20px 15px; text-align: center; }
.app-header img { width: 250px; max-width: 90%; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
.app-header h3 { margin: 10px 0 0 0; font-size: 14px; font-weight: 300; opacity: 0.9; letter-spacing: 1px; }

.container { max-width: 600px; margin: 0 auto; padding: 15px; }
.card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

h2 { font-size: 16px; color: var(--bg-app); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 8px; text-transform: uppercase; font-weight: 800; }
label { display: block; font-size: 12px; color: #555; margin-top: 10px; font-weight: 700; }
input.app-input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; margin-top: 5px; background: #f9f9f9; }

.total-box { background: #fff3f3; padding: 15px; border-radius: 10px; border: 1px dashed #ffcccc; }
.t-row { display: flex; justify-content: space-between; font-size: 13px; color: #666; margin-bottom: 5px; }
.t-row.final { border-top: 1px solid #ffcccc; margin-top: 8px; padding-top: 8px; color: var(--bg-app); font-weight: 900; font-size: 18px; }

/* Botones App */
.btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; margin-top: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.1s; box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
.btn-whatsapp { background: #25D366; color: white; }
.btn-pdf { background: #1a1a1a; color: white; }
.btn-danger { background: #ff4444; color: white; font-size: 12px; padding: 5px 10px; width: auto; display: inline-flex; }

/* Historial */
.history-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
.history-date { color: #888; font-size: 10px; }

/* Footer App */
.footer-app { text-align: center; font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 30px; }
.footer-whatsapp { display: flex; align-items: center; justify-content: center; margin-top: 8px; color: #25D366; font-weight: bold; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 20px; width: fit-content; margin-left: auto; margin-right: auto; padding-right: 15px; }

/* ================= PDF TEMPLATE ================= */
#pdf-template {
    display: none; width: 100%; background: white; padding: 40px 50px;
    font-family: 'Helvetica', 'Arial', sans-serif; color: #000; box-sizing: border-box; font-size: 12px;
}
.pdf-header { display: flex; justify-content: space-between; border-bottom: 4px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
.tech-branding h1 { margin: 0; font-size: 26px; text-transform: uppercase; font-weight: 900; }
.pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 11px; }
.pdf-table th { background: #2c3e50; color: white; padding: 10px; text-align: left; }
.pdf-table td { border: 1px solid #ccc; padding: 10px; }
.grand-total { background: #333; color: white !important; font-size: 14px !important; font-weight: 900 !important; }
.pdf-footer { margin-top: 60px; border-top: 1px solid #ddd; padding-top: 20px; display: flex; justify-content: space-between; }
</style>
</head>

<body>

<div id="login-screen">
    <img src="logotipo-guaiapp.png" class="login-logo-img" alt="Logo">
    <h1 class="login-title">Iniciar sesi√≥n en Gua'i App</h1>
    
    <div class="login-box">
        
        <div id="step-email">
            <label class="login-label">Direcci√≥n de correo electr√≥nico</label>
            <input type="email" id="loginEmail" class="login-input">
            <button class="btn-login-primary" onclick="sendAuthCode()">Enviar c√≥digo de acceso</button>
        </div>

        <div id="step-code" style="display:none">
            <label class="login-label" style="text-align:center">Ingrese el c√≥digo de 6 d√≠gitos</label>
            <input type="number" id="loginCode" class="login-input" style="text-align:center; letter-spacing:4px; font-weight:bold;">
            <button class="btn-login-primary" onclick="verifyCode()">Verificar</button>
            <div style="text-align:center; margin-top:10px;">
                 <a href="#" onclick="resetLogin()" style="font-size:12px; color:#0969da; text-decoration:none;">Volver</a>
            </div>
        </div>

        <div class="login-divider"><span>o</span></div>

        <button class="btn-login-google" onclick="sendAuthCode()">
            <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 0 24 24" width="18"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/><path d="M1 1h22v22H1z" fill="none"/></svg>
            Continuar con Google
        </button>
    </div>

    <div class="login-footer-links">
        <span>Crear una cuenta</span> ¬∑ <span>¬øOlvidaste tu contrase√±a?</span>
    </div>
</div>

<div id="app-container">
    <div class="app-header">
        <img src="logotipo-guaiapp.png" alt="Gua'i App">
        <h3>Panel T√©cnico Profesional</h3>
        <div style="font-size:10px; opacity:0.8; margin-top:5px">Usuario: <span id="user-license">-</span></div>
    </div>

    <div class="container">
        <div class="card">
            <h2>üë§ Cliente</h2>
            <input id="cliente" class="app-input" placeholder="Nombre del Cliente">
            <input id="rucCliente" class="app-input" placeholder="RUC / CI">
            <input id="telCliente" class="app-input" placeholder="Tel√©fono">
        </div>

        <div class="card">
            <h2>üõ†Ô∏è T√©cnico / Empresa</h2>
            <input id="tecnico" class="app-input" placeholder="Nombre T√©cnico">
            <input id="empresa" class="app-input" placeholder="Empresa (Opcional)">
            <input id="telTecnico" class="app-input" placeholder="Tel√©fono de Contacto">
        </div>

        <div class="card">
            <h2>üìã Servicios</h2>
            <label>Mantenimiento Preventivo (Gs.)</label><input type="number" id="s1" class="app-input" placeholder="0" oninput="calc()">
            <label>Mantenimiento Correctivo (Gs.)</label><input type="number" id="s2" class="app-input" placeholder="0" oninput="calc()">
            <label>Carga de Gas (Gs.)</label><input type="number" id="s3" class="app-input" placeholder="0" oninput="calc()">
            <label>Otro (Descripci√≥n)</label><input type="text" id="desc4" class="app-input" placeholder="Ej: Repuesto">
            <label>Precio Otro (Gs.)</label><input type="number" id="s4" class="app-input" placeholder="0" oninput="calc()">
        </div>

        <div class="card">
            <div class="total-box">
                <div class="t-row"><span>Subtotal Exentas:</span><span>0</span></div>
                <div class="t-row"><span>Subtotal IVA (10%):</span><span id="subDisplay">0</span></div>
                <div class="t-row"><span>Liquidaci√≥n IVA:</span><span id="ivaDisplay">0</span></div>
                <div class="t-row final"><span>TOTAL:</span><span>Gs. <span id="totalDisplay">0</span></span></div>
            </div>
        </div>

        <div class="card" style="background:transparent; box-shadow:none; padding:0;">
            <button class="btn btn-pdf" onclick="generateAndDownload()">üìÑ Descargar PDF</button>
            <button class="btn btn-whatsapp" onclick="sharePDFViaWhatsApp()">
                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326z"/></svg>
                Enviar PDF por WhatsApp
            </button>
            <button id="btnInstalar" class="btn" style="background:#FFC107; color:#333; display:none">üì≤ Instalar App</button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>üìÇ Historial</h2>
                <button class="btn-danger" onclick="clearHistory()">Borrar</button>
            </div>
            <div id="history-list" style="max-height: 200px; overflow-y: auto;">
                <p style="text-align:center; color:#999; font-size:12px;">Sin registros recientes.</p>
            </div>
        </div>

        <div class="footer-app">
            <b>GUA'I APP</b><br>
            Desarrollado por RHAB Tech<br>
            Divisi√≥n de RHAB INTERNATIONAL TRADING<br>
            guaiapp@rhabinternationaltrading.com
            <div class="footer-whatsapp" onclick="window.open('https://wa.me/595992755100')">
                +595 992 755 100
            </div>
        </div>
    </div>
</div>

<div id="pdf-template">
    <div class="pdf-header">
        <div class="tech-branding">
            <h1 id="pdf-empresa-header">EMPRESA</h1>
            <div id="pdf-tecnico-sub">T√©cnico</div>
            <div id="pdf-tel-header">Tel: ...</div>
        </div>
        <div class="doc-info" style="text-align:right">
            <div class="doc-title">PRESUPUESTO</div>
            <div class="doc-meta">
                N¬∞: <strong id="pdf-nro">0001</strong><br>
                Fecha: <span id="pdf-fecha">--</span>
            </div>
        </div>
    </div>
    <div class="pdf-client-box">
        <div style="font-weight:bold; border-bottom:1px solid #eee; margin-bottom:5px">CLIENTE:</div>
        <div><span id="pdf-cliente">-</span></div>
        <div>RUC: <span id="pdf-ruc">-</span></div>
        <div>Tel: <span id="pdf-tel-cli">-</span></div>
    </div>
    <table class="pdf-table">
        <thead><tr><th>Descripci√≥n</th><th style="text-align:right">Importe</th></tr></thead>
        <tbody id="pdf-table-body"></tbody>
    </table>
    <div style="text-align:right">
        <table style="width:250px; margin-left:auto; border-collapse:collapse">
            <tr><td>Subtotal IVA 10%:</td><td style="text-align:right" id="pdf-sub">0</td></tr>
            <tr><td>Liquidaci√≥n IVA:</td><td style="text-align:right" id="pdf-iva">0</td></tr>
            <tr class="grand-total"><td style="color:white; padding:5px;">TOTAL Gs.</td><td style="color:white; padding:5px; text-align:right" id="pdf-total">0</td></tr>
        </table>
    </div>
    <div class="pdf-footer">
        <div class="pdf-app-brand">
            <img src="logotipo-guaiapp.png" crossorigin="anonymous">
            <div>Tecnolog√≠a provista por <b>RHAB Tech</b> - RHAB INTERNATIONAL TRADING</div>
        </div>
    </div>
</div>

<script>
// --- 1. SISTEMA DE LOGIN (MOCK) ---
const MOCK_CODE = "123456"; 
const isLoggedIn = localStorage.getItem("guaiapp_user");

if(isLoggedIn) {
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("app-container").style.display = "block";
    document.getElementById("user-license").innerText = isLoggedIn;
    renderHistory();
}

function sendAuthCode() {
    const email = document.getElementById("loginEmail").value;
    // Simular que el bot√≥n Google tambi√©n lleva aqu√≠ por ahora
    if(!email && !document.getElementById("step-code").style.display === "block") {
         // Si es click en Google sin email, simulamos uno
         document.getElementById("loginEmail").value = "usuario@gmail.com";
    }

    // Simulamos env√≠o
    document.getElementById("step-email").style.display = "none";
    document.getElementById("step-code").style.display = "block";
    
    // Alerta del c√≥digo
    Swal.fire({
        title: 'Verifique su correo',
        text: `Su c√≥digo de acceso es: ${MOCK_CODE}`,
        icon: 'success'
    });
}

function verifyCode() {
    const code = document.getElementById("loginCode").value;
    if(code === MOCK_CODE) {
        localStorage.setItem("guaiapp_user", document.getElementById("loginEmail").value || "Usuario Google");
        Swal.fire({title: "¬°Bienvenido!", icon: "success", timer: 1500, showConfirmButton: false}).then(() => {
            location.reload();
        });
    } else {
        Swal.fire("Error", "C√≥digo incorrecto", "error");
    }
}

function resetLogin() {
    document.getElementById("step-code").style.display = "none";
    document.getElementById("step-email").style.display = "block";
}

// --- 2. C√ÅLCULOS ---
function calc() {
    const s1 = Number(document.getElementById("s1").value) || 0;
    const s2 = Number(document.getElementById("s2").value) || 0;
    const s3 = Number(document.getElementById("s3").value) || 0;
    const s4 = Number(document.getElementById("s4").value) || 0;
    const total = s1 + s2 + s3 + s4;
    const iva = Math.round(total / 11);
    const sub = total - iva;

    document.getElementById("totalDisplay").innerText = total.toLocaleString("es-PY");
    document.getElementById("subDisplay").innerText = sub.toLocaleString("es-PY");
    document.getElementById("ivaDisplay").innerText = iva.toLocaleString("es-PY");
    return { total, iva, sub, s1, s2, s3, s4 };
}

// --- 3. PDF Y WHATSAPP ---
function preparePDFElement(data) {
    if (data.total === 0) return null;
    const nro = "GUA-" + Math.floor(Math.random() * 9000 + 1000);
    const fecha = new Date().toLocaleDateString("es-PY");
    const empresa = document.getElementById("empresa").value;
    const tecnico = document.getElementById("tecnico").value || "T√âCNICO";
    
    document.getElementById("pdf-empresa-header").innerText = empresa || tecnico;
    document.getElementById("pdf-tecnico-sub").innerText = empresa ? tecnico : "Servicios T√©cnicos";
    document.getElementById("pdf-tel-header").innerText = "Tel: " + document.getElementById("telTecnico").value;
    document.getElementById("pdf-nro").innerText = nro;
    document.getElementById("pdf-fecha").innerText = fecha;
    document.getElementById("pdf-cliente").innerText = document.getElementById("cliente").value;
    document.getElementById("pdf-ruc").innerText = document.getElementById("rucCliente").value;
    document.getElementById("pdf-tel-cli").innerText = document.getElementById("telCliente").value;

    const tbody = document.getElementById("pdf-table-body");
    tbody.innerHTML = "";
    const addRow = (d, v) => { if(v>0) tbody.innerHTML += `<tr><td>${d}</td><td style="text-align:right">${v.toLocaleString("es-PY")}</td></tr>`; };
    
    addRow("Mantenimiento Preventivo A.A.", data.s1);
    addRow("Mantenimiento Correctivo A.A.", data.s2);
    addRow("Carga de Gas", data.s3);
    addRow(document.getElementById("desc4").value || "Extra", data.s4);

    document.getElementById("pdf-sub").innerText = data.sub.toLocaleString("es-PY");
    document.getElementById("pdf-iva").innerText = data.iva.toLocaleString("es-PY");
    document.getElementById("pdf-total").innerText = data.total.toLocaleString("es-PY");
    return nro;
}

function generateAndDownload() {
    const data = calc();
    const nro = preparePDFElement(data);
    if(!nro) return Swal.fire("Error", "Cargue un servicio", "warning");

    const element = document.getElementById("pdf-template");
    element.style.display = "block";
    const opt = { margin: 0, filename: `Presupuesto_${nro}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'legal', orientation: 'portrait' } };

    html2pdf().set(opt).from(element).save().then(() => {
        element.style.display = "none";
        addToHistory(nro, data.total);
    });
}

async function sharePDFViaWhatsApp() {
    const data = calc();
    const nro = preparePDFElement(data);
    if(!nro) return Swal.fire("Error", "Cargue un servicio", "warning");

    const element = document.getElementById("pdf-template");
    element.style.display = "block";
    Swal.fire({title: 'Generando PDF...', didOpen: () => Swal.showLoading()});

    const opt = { margin: 0, filename: `Presupuesto_${nro}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'legal', orientation: 'portrait' } };

    html2pdf().set(opt).from(element).outputPdf('blob').then(async (pdfBlob) => {
        element.style.display = "none";
        Swal.close();
        const file = new File([pdfBlob], `Presupuesto_${nro}.pdf`, { type: "application/pdf" });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file], title: 'Presupuesto', text: `Presupuesto N¬∞ ${nro}` });
        } else {
            Swal.fire("Info", "Su navegador descargar√° el PDF. Adj√∫ntelo manualmente.", "info");
            const a = document.createElement("a");
            a.href = URL.createObjectURL(pdfBlob);
            a.download = `Presupuesto_${nro}.pdf`;
            a.click();
        }
        addToHistory(nro, data.total);
    });
}

// --- 4. HISTORIAL ---
function addToHistory(nro, total) {
    const cliente = document.getElementById("cliente").value || "Cliente";
    const history = JSON.parse(localStorage.getItem("guai_history") || "[]");
    history.unshift({ nro, date: new Date().toLocaleDateString(), client: cliente, amount: total.toLocaleString("es-PY") });
    localStorage.setItem("guai_history", JSON.stringify(history));
    renderHistory();
}

function renderHistory() {
    const history = JSON.parse(localStorage.getItem("guai_history") || "[]");
    const list = document.getElementById("history-list");
    list.innerHTML = "";
    if(history.length === 0) { list.innerHTML = '<p style="text-align:center; color:#999; font-size:12px;">Sin registros.</p>'; return; }
    history.forEach(i => {
        list.innerHTML += `<div class="history-item"><div><strong>${i.client}</strong><br><span class="history-date">${i.date} ‚Ä¢ ${i.nro}</span></div><div style="font-weight:bold">Gs. ${i.amount}</div></div>`;
    });
}
function clearHistory() {
    localStorage.removeItem("guai_history"); renderHistory();
}
renderHistory();

// --- 5. PWA ---
let deferredPrompt;
window.addEventListener("beforeinstallprompt", e => { e.preventDefault(); deferredPrompt = e; document.getElementById("btnInstalar").style.display = "flex"; });
document.getElementById("btnInstalar").onclick = async () => { if(deferredPrompt) { deferredPrompt.prompt(); deferredPrompt = null; } };
if ("serviceWorker" in navigator) navigator.serviceWorker.register("sw.js");

function shareApp() { if(navigator.share) navigator.share({title:"GUA'ƒ® APP", url:location.href}); else Swal.fire("Enlace", location.href, "info"); }
</script>
</body>
</html>
