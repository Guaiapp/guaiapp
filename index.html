<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GUAâ€™Ä¨ APP | Presupuesto TÃ©cnico</title>

<link rel="manifest" href="manifest.json">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --primary:#0b5ed7;
  --green:#28a745;
  --gray:#6c757d;
  --bg:#f4f6f8;
}

body{
  margin:0;
  font-family:system-ui,Arial;
  background:var(--bg);
  padding-bottom: 40px;
}

.header{
  background:var(--primary);
  color:#fff;
  text-align:center;
  padding:20px;
}

.header img{
  width:260px;
  max-width:90%;
}

.container{padding:16px;}

.card{
  background:#fff;
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.08);
}

h2{color:var(--primary);font-size:16px;}

input{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
  box-sizing: border-box; /* Ajuste para evitar desbordes */
}

.service{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
}

.total{
  font-size:18px;
  font-weight:700;
  margin-top:10px;
}

.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:600;
  margin-top:10px;
  cursor: pointer;
}

.btn-blue{background:var(--primary);color:#fff;}
.btn-green{background:var(--green);color:#fff;}
.btn-gray{background:var(--gray);color:#fff;}

.footer{
  text-align:center;
  font-size:12px;
  color:#555;
  margin:20px 0;
}
</style>
</head>

<body>

<div class="header">
  <img src="logotipo-guaiapp.png" alt="Gua'i App Logo">
  <h3>PRESUPUESTO TÃ‰CNICO DE SERVICIOS DE CLIMATIZACIÃ“N</h3>
</div>

<div class="container" id="pdf">

<div class="card">
<h2>Datos</h2>
<input id="cliente" placeholder="Nombre del cliente">
<input id="tecnico" placeholder="Nombre del tÃ©cnico">
<input id="empresa" placeholder="Empresa del tÃ©cnico">
</div>

<div class="card">
<h2>Servicios (IVA incluido)</h2>

<div class="service"><input type="checkbox" onchange="calc()"> Mantenimiento preventivo <input type="number" id="s1" placeholder="Gs."></div>
<div class="service"><input type="checkbox" onchange="calc()"> Mantenimiento correctivo <input type="number" id="s2" placeholder="Gs."></div>
<div class="service"><input type="checkbox" onchange="calc()"> Carga de gas <input type="number" id="s3" placeholder="Gs."></div>
<div class="service"><input type="checkbox" onchange="calc()"> Otro servicio <input type="number" id="s4" placeholder="Gs."></div>

<div class="total">Total: Gs. <span id="total">0</span></div>
<div>IVA (10%): Gs. <span id="iva">0</span></div>
</div>

<div class="card">
<button class="btn btn-blue" onclick="calc()">Calcular total</button>
<button class="btn btn-green" onclick="downloadPDF()">Descargar PDF</button>
<button class="btn btn-green" onclick="sendWhats()">Enviar por WhatsApp</button>

<button id="btnInstalar" class="btn btn-gray" style="display:none">ðŸ“² Instalar App</button>
<button class="btn btn-gray" onclick="shareApp()">ðŸ”— Compartir App</button>
</div>

<div class="card">
<h2>Historial Empresa</h2>
<button class="btn btn-gray" onclick="viewHistory()">Ver historial</button>
<button class="btn btn-gray" onclick="exportCSV()">Exportar CSV</button>
<button class="btn btn-gray" onclick="clearHistory()">Borrar historial</button>
</div>

</div>

<div class="footer">
Generado a travÃ©s de <b>GUAâ€™Ä¨ APP</b><br>
Plataforma digital de presupuestos tÃ©cnicos de climatizaciÃ³n<br>
Desarrollado por RHAB Tech â€“ RHAB INTERNATIONAL TRADING<br>
guaiapp@rhabinternationaltrading.com Â· info@rhabinternationaltrading.com
</div>

<script>
let deferredPrompt;

// Escucha el evento para habilitar la instalaciÃ³n
window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById("btnInstalar");
  btn.style.display = "block";
  btn.style.background = "#0b5ed7"; // Ponerlo azul para destacar cuando estÃ© listo
  btn.style.color = "#fff";
});

// LÃ³gica de cÃ¡lculo
function calc(){
  let sum = 0;
  ["s1","s2","s3","s4"].forEach(id=>{
    // Busca el input hermano del checkbox
    const inputNum = document.getElementById(id);
    const checkbox = inputNum.parentElement.querySelector('input[type="checkbox"]');
    
    // Solo suma si el checkbox estÃ¡ marcado o si el usuario escribiÃ³ algo
    // (Ajuste para que sea mÃ¡s intuitivo: si escriben monto, lo cuenta)
    if(inputNum.value > 0) {
        checkbox.checked = true;
        sum += Number(inputNum.value);
    } else {
        checkbox.checked = false;
    }
  });
  document.getElementById("total").innerText = sum.toLocaleString("es-PY");
  document.getElementById("iva").innerText = Math.round(sum/11).toLocaleString("es-PY");
}

function downloadPDF(){
  const element = document.getElementById("pdf");
  const opt = {
    margin: 0.5,
    filename: 'Presupuesto_GuaiApp.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
}

function sendWhats(){
  const cliente = document.getElementById("cliente").value;
  const total = document.getElementById("total").innerText;
  if(total === "0") { alert("Calcula el total antes de enviar."); return; }
  
  const msg = `Presupuesto tÃ©cnico generado vÃ­a GUAâ€™Ä¨ APP%0ACliente: ${cliente}%0ATotal: Gs. ${total}`;
  window.open("https://wa.me/?text="+msg);
}

function shareApp(){
  if (navigator.share) {
    navigator.share({title:"GUAâ€™Ä¨ APP", url:location.href});
  } else {
    alert("Copia este enlace: " + location.href);
  }
}

// Historial (Local Storage)
function saveToHistory(monto){
    const h = JSON.parse(localStorage.getItem("guai_historial")||"[]");
    h.push({fecha:new Date().toLocaleString(), total: monto});
    localStorage.setItem("guai_historial",JSON.stringify(h));
}

// Modificamos calc para que no guarde automÃ¡ticamente, 
// sino que podrÃ­as agregar un botÃ³n "Guardar" si quisieras.
// Por ahora dejamos la lÃ³gica de visualizaciÃ³n:

function viewHistory(){
  const h = JSON.parse(localStorage.getItem("guai_historial")||"[]");
  if(h.length === 0) { alert("Sin historial"); return; }
  let msg = "Ãšltimos presupuestos:\n";
  h.slice(-5).forEach(i => msg += `${i.fecha}: ${i.total}\n`);
  alert(msg);
}

function exportCSV(){
  const h = JSON.parse(localStorage.getItem("guai_historial")||"[]");
  let csv="Fecha,Total\n";
  h.forEach(r=>csv+=`${r.fecha},"${r.total}"\n`);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "historial_guaiapp.csv";
  a.click();
}

function clearHistory(){
  if(confirm("Â¿Borrar todo el historial?")){
    localStorage.removeItem("guai_historial");
    alert("Historial borrado");
  }
}

// LOGICA DE INSTALACIÃ“N SOLICITADA
const btnInstalar = document.getElementById("btnInstalar");
btnInstalar.onclick = async () => {
  if (!deferredPrompt) {
    alert("La instalaciÃ³n no estÃ¡ disponible en este momento. \n\n1. AsegÃºrate de estar en Google Chrome (Android/PC).\n2. Si ya la instalaste antes, bÃ³rrala o busca la app en tu menÃº.\n3. Verifica que 'manifest.json' y 'sw.js' estÃ©n cargados.");
    return;
  }
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;
  if (outcome === 'accepted') {
    btnInstalar.style.display = "none";
  }
};

// Registro del Service Worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js")
    .then(reg => console.log("SW registrado", reg))
    .catch(err => console.log("SW error", err));
}
</script>

</body>
</html>
